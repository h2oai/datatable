FROM FROM_SUBST

MAINTAINER H2o.ai <ops@h2o.ai>

RUN \
    yum groupinstall -y "Development Tools"

RUN \
    yum install -y \
        ncurses-devel \
        zlib-devel \
        wget \
        bzip2

RUN \
    mkdir -p /opt/h2oai/dai

RUN \
    wget -q https://s3.amazonaws.com/artifacts.h2o.ai/releases/ai/h2o/dai-python/master-21/ARCH_SUBST-centos7DEBUG_SUBST/python.tar.bz2 && \
    tar xf python.tar.bz2 && \
    mv python /opt/h2oai/dai && \
    rm -f python.tar.bz2

RUN \
    wget -q https://s3.amazonaws.com/artifacts.h2o.ai/releases/ai/h2o/dai-thirdparty-deps-llvm/1.0-master-21/ARCH_SUBST-centos7/llvm.tar.bz2 && \
    tar xf llvm.tar.bz2 && \
    cp -r llvm/* /opt/h2oai/dai/ && \
    rm -rf llvm*

ENV LLVM4=/opt/h2oai/dai
ENV PATH=/opt/h2oai/dai/python/bin:$PATH
ENV LD_LIBRARY_PATH=/opt/h2oai/dai/python/lib:$LD_LIBRARY_PATH
ENV PATH=/usr/local/bin:$PATH
ENV PATH=$LLVM4/bin:$PATH
ENV PANDAS_VERSION=0.20.0

RUN pip install llvmlite==0.20.0 wheel virtualenv

RUN mv /opt/h2oai/dai/bin/clang++ /opt/h2oai/dai/bin/clang++2

# A separated layer to collect core dumps
RUN mkdir -p /tmp/cores && chmod a+rwx /tmp/cores

COPY clang++_wrapper.sh /opt/h2oai/dai/bin/clang++

